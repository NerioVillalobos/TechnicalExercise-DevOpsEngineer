on:
  push:
    branches: [ "sprint/*" ]

jobs:
  build-deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: simplemicroservice
      TAG: pr-${{ github.run_number }}
      NAMESPACE: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build & run unit tests
        run: |
          chmod +x ./mvnw
          ./mvnw -B clean package

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:$TAG .

      - name: Smoke test container (local)
        run: |
          docker run -d -p 8080:8080 --name test-$IMAGE_NAME $IMAGE_NAME:$TAG
          echo "Esperando a que el contenedor esté listo..."
          sleep 10
          curl -f http://localhost:8080/health
          docker stop test-$IMAGE_NAME
          docker rm test-$IMAGE_NAME

      # Desde aquí es "despliegue simulado" a Kubernetes.
      # No hacemos push a ningún registry.

      #- name: Set up kubectl
      #  uses: azure/setup-kubectl@v4
      #  with:
      #    version: 'v1.30.0'
      #
      #- name: Deploy to Kubernetes Test Namespace (simulado)
      #  if : $ {{ secrets.KUBE_CONFIG_DATA != '' }}
      #  env:
      #    KUBE_CONFIG_DATA: $ {{ secrets.KUBE_CONFIG_DATA }}
      #  run: |
      #    echo "$KUBE_CONFIG_DATA" | base64 -d > kubeconfig
      #    export KUBECONFIG=kubeconfig
      #    kubectl apply -n $NAMESPACE -f k8s/deployment.yaml
      #    kubectl apply -n $NAMESPACE -f k8s/service.yaml
      #    kubectl apply -n $NAMESPACE -f k8s/ingress.yaml || true
      #    kubectl rollout status deployment/$IMAGE_NAME -n $NAMESPACE
      #    kubectl get pods -n $NAMESPACE
